# O/Rマッパーを使用してデータベースへ接続する

## ORM

- MyBatis, JPAあたりがメジャー

## 導入

- mybatis, mysql-connector-javaがmybatis, mysqlを繋げるライブラリ
- dynamic-sql, mybatis-generator-coreがコード生成を行うもの

- `com.arenagod.gradle.MybatisGenerator`は`com.qqviaja.gradle.MybatisGenerator`に修正
- 設定ファイル`generatorConfig.xml`を作成
- gradleのコマンド`mbGenerator`を実行するとファイルが生成される

ファイル生成は`MybatisGenerator`の機能で`Mybatis`の機能ではない
実行すると各テーブルを表したモデルやマッパーが生成される
enum型は文字列として認識されてしまうのでカラムのオーバーライドを行うことによって書き換えるようにする

## 生成されるファイル

全てテーブル名が先に付いている

- Record → テーブルを表したモデル
- DynamicSqlSupport → Mapperを使用するクエリのカラム指定のパラメーターが記述されている
- Mapper → 基本的なクエリ発行の関数が定義されたインターフェース(クエリの結果のどのカラムがどれに該当するのかを表したもの)
- MapperExtensions → Mapperの関数の定義

## アプリケーション設定

- 設定はapplication.propertiesで行うことができるが最近はymlを使うことが多いので`application.yml`という名前に変更して記述する

## 関数の拡張

- 関数を拡張する場合はMapper, MapperExtensions, Recordを定義する必要がある
- Mapper → どのような関数を作るのか・その時の結果のマッピングはどういった感じになるのか(マッピングは他のものと結果が同じの場合idだけで良い)
- MapperExtensions → その実装

**kotlin関係**

- 一時的に使うだけの変数はクラスのフィールド名を差別化するため変数名の最初に_をつけると良い
- if (hoge != null)で処理をする場合はletと組み合わせる
- if (hoge == null)で処理をする場合はエルビス演算子:?を使う

## 関数が既に生成されている場合の取得方法

- 既にある場合はRepositoryインターフェースに関数を定義・実装してサービス・コントローラーで使うだけで良い

アノテーション
`@Transactional` 関数内の処理にトランザクションを貼り例外が発生した場合はロールバックを行う

# Spring Security

**5系と6系で大分違うので注意すること・5.8は6系への準備となっているのでそこも少し変わっている**

- 認証・認可といったセキュリティ周りはSpring Securityを使って行う
- スターターをインストールするだけでオッケー

## 大まかな流れ

基本的な方針としては用意されているインターフェースをどんどん実装していく
どのインターフェースを実装する必要があるのか・どのような関数があるのかは理解しておく必要がありそう

1. まずは設定ファイルを作成
    - `WebSecurityConfigurerAdapter`を継承・EnableWebSecurityアノテーションを付けること
    - ここでどのルートに認証が必要なのかどういった権限が必要なのか定義
    - ログインパスに来た場合どの値がどれに値するかを定義
    - 認証成功・失敗・未認証といった状態の時に実行するべき関数
    - 認証にはどの関数を使うのか
2. それぞれの要素に対応した認証サービスを作成
    - ユーザーはどういった形なのか・ユーザー名やパスワードに当たる変数はどれなのかを`UserDetails`型に当てはめて関数を実装することによって伝える
3. 各種状態に応じたハンドラーを実装
    - 認証に成功した場合
    - 認証に失敗した場合
    - 未認証の場合
    - 認可に失敗した場合

